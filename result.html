<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ぐるなび周辺検索</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<body>
  検索結果:現在地より<span id="range"></span>mの範囲内で見つかったレストラン<br/>
  <span class="prev">前</span>
  <span class="page"></span>
  <span class="next">次</span>
  
  <table id="table" border="1">
    <tr><th>店舗名</th><th>アクセス(断りのない限り徒歩です)</th><th>画像</th></tr>
  </table>
  
  <span class="prev">前</span>
  <span class="page"></span>
  <span class="next">次</span><br/>
  <a href="search.html">検索ページに戻る</a>
  
  <script>
  
    // GETパラメータを取得
    function getQueryString() {
      if(document.location.search.length <= 1) {
        return null;
      }
      
      var params = document.location.search.substring(1).split('&');
      var result = new Object();
      for(var i = 0; i < params.length; i++) {
        var elem = params[i].split('=');
        result[decodeURIComponent(elem[0])] = decodeURIComponent(elem[1]);
      }
      return result;
    }
  
    // アクセスの文字列化
    function getAccessString(access) {
      var str = access.line + access.station + access.station_exit;
      if(access.walk) {
        str += "より" + access.walk + "分";
      }
      if(access.note) {
        str += "(" + access.note + ")";
      }
      return str;
    }
  
    // 検索結果表示
    function showResult(result) {
      if(result.error) {
        alert("エラー:" + result.error.code + " " + result.error.message);
      }
      
      if(result.total_hit_count == 0) {
        alert("検索結果が見つかりませんでした");
      }
      // テーブルをヘッダ以外クリア
      $("#table td").parent().remove();
      // 検索結果を順次追加
      for(var i in result.rest) {
        var str = "<tr><td><a href=\"detail.html?rest_id=" + result.rest[i].id + "\">"
          + result.rest[i].name + "</a></td><td>"
          + getAccessString(result.rest[i].access) + "</td>";
          
        if(result.rest[i].pr.pr_short) {
          str += "<td rowspan=\"2\">"
          + "<img src=\"" + result.rest[i].image_url.shop_image1 + "\"></td></tr>"
          + "<tr><td colspan=\"2\">" + result.rest[i].pr.pr_short + "</td></tr>";
        } else {
          str += "<td>"
          + "<img src=\"" + result.rest[i].image_url.shop_image1 + "\"></td></tr>";
        }
        
        $("#table").append(str);
      }
    }
  
    $(function() {
  
    var query = getQueryString();
    var url = "https://api.gnavi.co.jp/RestSearchAPI/v3/";
    var params = {
      keyid: "21a74b591f5aca9b1ebde8b6c7609ebb",
      latitude: query["latitude"],
      longitude: query["longitude"],
      range: query["range"],
      offset_page: query["offset_page"]
    };
  
    var total = 0;
    
    // 検索
    $.getJSON(url, params, function(result) {
      showResult(result);
      total = result.total_hit_count;
      
      // range表示
      var r = 0;
      switch(query["range"]) {
      case "1":
        r = 300;
        break;
      case "2":
        r = 500;
        break;
      case "3":
        r = 1000;
        break;
      case "4":
        r = 2000;
        break;
      case "5":
        r = 3000;
        break;
      default:
        r = null;
        alert("範囲指定が不正です");
      }
      $("#range").html(r);
      // 表示中のヒット番号を表示
      var str = ((Number(query["offset_page"]) - 1)*10 + 1);
      if(Number(query["offset_page"])*10 < total) {
        str += "~" + (Number(query["offset_page"])*10);
      } else {
        str += "~" + total;
      }
      $(".page").html(str + "/" + total);
    });
    
    // 「前」クリック
    $(".prev").click(function() {
      // 前ページがなければ何もしない
      if(query["offset_page"] <= 1) {
        return;
      }
      // 前ページに飛ぶ
      document.location = "result.html?latitude=" + query["latitude"] + "&longitude=" + query["longitude"]
            + "&range=" + query["range"] + "&offset_page=" + (Number(query["offset_page"]) - 1);
    });
    
    // 「次」クリック
    $(".next").click(function() {
      // 次ページがなければ何もしない
      if(Number(query["offset_page"])*10 >= total) {
        return;
      }
      // 次ページに飛ぶ
      document.location = "result.html?latitude=" + query["latitude"] + "&longitude=" + query["longitude"]
            + "&range=" + query["range"] + "&offset_page=" + (Number(query["offset_page"]) + 1);
    });
    
    });
  
  </script>
  
  <style>
  .prev, .next {
    color: blue;
    cursor: pointer;
    text-decoration: underline;
  }
  </style>
</body>

</html>
